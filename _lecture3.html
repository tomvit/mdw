<!DOCTYPE html>
<!--
    Middleware and Web Services, CTU course slides
    (cc) 2010-2012 Tomas Vitvar, http://vitvar.com
    written for Humla, an open source HTML5 presentation environment
-->
<html>  
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
        <meta name="course"   content="Middleware and Web Services"/>
		<meta name="lecture"  content="Lecture 3"/>
   		<meta name="keywords" content="HTTP, Web Server, Synchronous, Asynchronous, RMI"/>
           
        <link type="text/css" rel="stylesheet" href="css/meta.css"></link>   
        <link type="text/css" rel="stylesheet" href="css/ctu-fit.css"></link>   
        <link type="text/css" rel="stylesheet" href="humla/lib/core/humla.css"></link>   

        <script type="text/javascript" src="humla/lib/humla.js"></script>
        <title>Application Protocols</title>
	</head>
	
	<body>
		<footer>
			<p><b>#META_LECTURE#: #TITLE#</b>,&nbsp;<span class="meta_semester"/>,&nbsp;
			<span class="meta_twitter"/></p>
			<p><b>&#8210; #SLIDE_NO# &#8210;</b></p>
		</footer>

    	<div class="slide intro">
			<hgroup>
				<h1><span class="meta_course"/></h1>
 				<h2>#META_LECTURE#: #TITLE#</h2>
			</hgroup>
			<div class="author">
				<p class="meta_author"/>
				<p><span class="meta_email"/> &bull; <span class="meta_twitter"/> &bull; 
				<span class="meta_web"/></p>
			</div>
			<center><div class="meta_logo"></div></center>
			<div class="org">
				<p class="meta_org"/>
				<p><span class="meta_orgfac"/> &bull; <span class="meta_field"/> 
				&bull; <span class="meta_orgweb"/></p>
			</div>
			<div class="etc">
        		<div class="text-info">
    				Modified: #LAST_MODIFIED#<br/>
					Humla v#HUMLA_VERSION#
				</div>
				<a href="http://creativecommons.org/licenses/by-sa/3.0/"><div class="license"></div></a>
				<div class="oppa"></div>
			</div>
		</div>

        <div class="slide outline"></div>
        
        <section>
            <header>Introduction to Application Protocols</header>
            
            <div class="slide">
                <hgroup>
                    <h1>Application Protocols</h1>
                </hgroup>                
                <ul class="x-small">
                    <li>Remember this</li>
                </ul>
                <div class="h-drawing" id="19zJkisQOr32yxVeMcXEi7B3fHAtSot0c_ppDJeKl4bc" style="height: 120px; margin-top: -10px"></div>
                <ul class="x-small">
                    <li>App protocols mostly on top of the TCP Layer</li>
                    <ul>
                        <li>use TCP socket for communication</li>
                    </ul>
                    <li>Major protocols</li>
                    <ul>
                        <li>HTTP &#150; most of the app protocols layered on HTTP</li>
                        <ul>
                            <li>wide spread, but: implementors often break HTTP semantics</li>                            
                        </ul>
                        <li>RMI &#150; Remote Method Invocation</li>
                        <ul>
                            <li>Java-specific, rather interface</li> 
                            <li>may use HTTP underneath (among other things)</li>
                        </ul>
                        <li>XML-RPC &#150; Remote Procedure Call and SOAP</li>
                        <ul>
                            <li>Again, HTTP underneath</li>
                        </ul>
                        <li>WebSocket &#150; new protocol part of HTML5</li>                        
                    </ul>
                </ul>
            </div>
            
            <div class="slide">
                <hgroup>
                    <h1>Socket</h1>
                </hgroup>            
				<div class="h-drawing" style="height: 140px" 
                    id="1Z4OmMLdUPPmmfAsENj7zBb_kjDOWVUzku50WucxpePU"></div>
				<ul class="xx-small">
					<li>Handshaking (connection establishment)</li>
					<ul>
                        <li>The server listens at <code>[dst_ip,dsp_port]</code></li>
                        <li>Three-way handshake:</li>
                        <ul>
                            <li>the client at <code>[src_ip,src_port]</code> sends a connection request</li> 
                            <li>the server responds</li>
                            <li>the client acknowledges the response, can send data along</li>
                        </ul>
                        <li>Result is a socket (virtual communication channel) with unique identification:<br/>
						<code>socket=[src_ip,src_port;dst_ip,dst_port]</code></li>
					</ul>
					<li>Data transfer (resource usage)</li>
					<ul>
						<li>Client/server writes/reads data to/from the socket</li>
                        <li>TCP features: reliable delivery, correct order of packets, flow control</li> 
					</ul>
					<li>Connection close</li>
				</ul>
            </div>

            <div class="slide">
                <hgroup>
                    <h1>Addressing in Application Protocol</h1>
                </hgroup>            
    			<div class="h-drawing" style="height: 220px" 
                    id="1a6OhSNel7-1HC-NaWmmkRfIOyQqlvaoXGyJws1rAuZU"></div>
				<ul class="xx-small">
					<li>IP addressing: IP is an address of a machine interface</li>
                    <ul>
                        <li>A machine can have multiple interfaces (eth0, eth1, bond0, ...)</li>
                    </ul>
                    <li>TCP addressing: TCP port is an address of an app running on a machine and listening on a machine interface</li>
                    <ul>
                        <li>Multiple applications with different TCP ports may listen on a machine interface</li>
                    </ul>
                    <li>Application addressing</li>
                    <ul>
                        <li>Additional mechanisms to address entities within an application</li>
                        <li>They are out of scope of IP/TCP, they are app specific</li>
                        <ul>
                            <li>for example, Web apps served by a single Web server</li>
                        </ul>
                    </ul>
                </ul>    
            </div>

            <div class="slide">
                <hgroup>
                    <h1>Virtual IP</li>
                </hgroup>
                <div class="h-drawing" style="height: 220px" 
                    id="1I1Hnhwi9i_VpmebflPS1NqKud_yb1CjOkb7CR0KVdkg"></div>
                <ul class="xx-small">
                    <li>Virtual IP</li>
                    <ul>
                        <li>Additional IP addresses assigned to a network interface</li>
                        <ul>
                            <li>For example, <code>eth0 &ndash; eth0:1, eth0:2, eth0:3, ...</code></li>
                            <li>A process can bind to the virtual IP</li>
                            <li>Multiple processes can listen on the same tcp port but on different virtual IPs</li> 
                        </ul> 
                    </ul>
                    <li>Benefits</li>
                    <ul>
                        <li>Floating IP &ndash; a process can move transparently to another physical machine</li>
                        <li>Network configuration can be preserved, no need to reconfigure</li>
                        <li>Failover concept uses floating IPs</li>
                    </ul>
                </ul>
            </div>

            <div class="slide">
                <hgroup>
                    <h1>Virtual IP Configuration</li>
                </hgroup>
                <ul class="x-small">
                    <li>Steps to configure virtual IP in Linux (example for <code>eth0</code>)</li>
                    <ol>
                        <li>Find out the interface's network mask</li>
                        <pre class="brush: bash; class-name: 'x-small tight'">
                            $ ifconfig eth0
                            eth0      Link encap:Ethernet  HWaddr 00:0C:29:AB:5E:6A
                            inet addr:172.16.169.184  Bcast:172.16.169.255  Mask:255.255.255.0
                            ...
                        </pre>

                        <li>Create virtual IP using <code>ifconfig</code></li>
                        <ul>
                            <li>it should use the same network mask</li>
                            <li>it should be free, usually allocated to be used as a virtual IP</li>
                        </ul>
                        <pre class="brush: bash; class-name: 'x-small tight'; first-line: 5">
                            $ sudo ifconfig eth0:1 172.16.169.184 netmask 255.255.255.0
                            $ ifconfig eth0:1
                            eth0:1    Link encap:Ethernet  HWaddr 00:0C:29:AB:5E:6A
                                      inet addr:172.16.169.186  Bcast:172.16.169.255  Mask:255.255.255.0
                        </pre>
                        <li>Update neighbours' ARP (Address Resolution Protocol) caches</li>
                        <ul>
                            <li>to associate the virtual IP with MAC address of <code>eth0</code></li>
                            <li>when the virtual IP was in use on other node or interface</li>
                        </ul>                        
                        <pre class="brush: bash; class-name: 'x-small tight'; first-line: 9">
                            $ sudo arping -q -U -c 3 -I eht0 172.16.169.184
                        </pre>
                    </ol>
                    <li class="task">Tasks</li>
                    <ul>
                        <li>Configure a virtual IP on your computer and test it using <code>ping</code></li>
                    </ul>
                </ul>
            </div>

            <div class="slide outline"></div>

            <section>
                <header>Synchronous and Asynchronous Communication</header>

                <div class="slide" id="sync-async-comm">
                    <hgroup>
                        <h1>Synchronous and Asynchronous Communication</h1>
                    </hgroup>   
                    <div class="h-drawing" style="height: 220px" 
                        id="14daki2YQxkRxkpg_RW16-Efihlxzhep8AWXb226NaQA"></div>                                
    				<ul class="x-small">
                        <li>Synchronous</li>
                        <ul>
            				<li>one socket, |t<sub>req</sub> &#150; t<sub>res</sub>| is small</li> 
            				<li>easy to implement and deploy, only standard firewall config</li>
            				<li>only the server defines endpoint</li>
                        </ul>
                        <li>Asynchronous</li>
                        <ul>
                            <li>request, response each has socket, client and server define endpoints</li>
            				<li>|t<sub>req</sub> &#150; t<sub>res</sub>| can be large (hours, even days)</li> 
            				<li>harder to do across network elements (private/public networks issue)</li>
                        </ul>
    				</ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Asynchronous via Intermediary</h1>
                    </hgroup>   
                    <div class="h-drawing" style="height: 220px" 
                        id="1mh4fk7kNmLyqVT1Cks4rRFRpGjFcU1yStOYQw2uiew8"></div>                                
                    <ul class="x-small">
                        <li>Intermediary</li>
                        <ul>
                            <li>A component that decouples a client-server communication</li>
                            <li>It increases reliability and performance</li>
                            <ul>
                                <li>The server may not be available when a client sends a request</li>
                                <li>There can be multiple servers that can handle the request</li>
                            </ul>
                        </ul>
                        <li>Further Concepts</li>
                        <ul>
                            <li>Message Queues (MQ) &ndash; queue-based communication</li>
                            <li>Publish/Subscribe (P/S) &ndash; event-driven communication</li> 
                        </ul> 
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Asynchronous via Polling</h1>
                    </hgroup>   
                    <div class="h-drawing" style="height: 220px" 
                        id="1F3GsWbkka-hDU75qAzFl1OlhtMMHt_gfxE9m3CcvlAk"></div>                                
                    <ul class="x-small">
                        <li>Polling &ndash; only clients open sockets</li>
                        <ul>
                            <li>A client performs multiple request-response interactions</li>
                            <ul>
                                <li>The first interaction initiates a process on the server</li>
                                <li>Subsequent interaction check for the processing status</li>
                                <li>The last interaction retrieves the processing result</li>
                            </ul>
                        </ul>
                        <li>Properties of environments</li>
                        <ul>
                            <li>A server cannot open a socket with the client (network restrictions)</li>
                            <li>Typically on the Web (a client runs in a browser)</li> 
                        </ul>
                    </ul>
                </div>

            </section>

            <div class="slide outline"></div>

            <section>
                <header>Selected Networking Concepts</header>
                
                <div class="slide">
                    <hgroup>
                        <h1>Public/Private Network Configuration</li>
                    </hgroup>
                    <div class="h-drawing" id="18RcCN5lYzGkQi1AMzmfkFgMA0JerPmcVCSjWrZj1TuQ" 
                        style="height: 270px"></div>
                    <ul class="x-small">
                        <li>Adds complexity to configuration of application</li>
                        <ul>
                            <li>Config example at server with <code>eth0 = 147.32.100.1</code> (iptables)</li>                        
                        </ul>
                        <pre class="brush: bash; class-name='xx-small'">
                            # enable ip forwarding from one interface to another within linux core
                            echo 1 > /proc/sys/net/ipv4/ip_forward
                            
                            # redirect all communication coming to tcp/3000 to 192.168.1.2:4000
                            iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3000 -j DNAT \
                                --to-dest 192.168.1.2 --to-port 4000
                        </pre>
                    </ul>
                </div>
    
                <div class="slide">
                    <hgroup>
                        <h1>Demilitarized Zones</li>
                    </hgroup>
                    <div class="h-drawing" id="117YB9D3KXyYVXZeYlt9lHiLD9F1HbOBhcYYnxEBGeDQ" 
                        style="height: 270px"></div>
                    <ul class="x-small">
                        <li>DMZ = Demilitarized Zone</li>
                        <ul>
                            <li>subnet within an organization's network on a public network</li>
                            <li>special care of security enforced through internal policies</li>
                            <li>For example:</li>
                            <ul>
                                <li>no access to all live data, subsets copied in batches</li>
                                <li>frequent monitoring</li> 
                            </ul>
                        </ul>
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Virtual Private Network</li>
                    </hgroup>
                    <div class="h-drawing" id="1Ny_2ymBwHb45xibAqrUFE_1iW-K8in05CbI5bIiY5XE" 
                        style="height: 270px"></div>
                    <ul class="xx-small">
                        <li>VPN = Virtual Private Network</li>
                        <ul>
                            <li>an overlay network between a client and a server</li>
                            <li>the network spans accross underlying network elements</li>
                            <li>Example:</li>
                            <ul>
                                <li>VPN client starts a VPN connection with the VPN server via network interfaces</li>
                                <li>VPN server assigns an IP address to the VPN client from the server's subnet</li> 
                                <li>Packets in VPN communication are encrypted and sent out in an outer VPN packet, e.g. IPSec packet</li>
                            </ul>
                        </ul>
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Proxy Server</li>
                    </hgroup>
                    <div class="h-drawing" id="1zt7pfPYpd5cdHu92rimaRelwjKHkHeeA7AhHnrerI74" 
                        style="height: 270px"></div>
                    <ul class="xx-small">
                        <li>Proxy Server</li>
                        <ul>
                            <li>Centralized access control based on content</li>
                            <li>Perfoms request on behalf of the client</li>
                            <ul>
                                <li>Caches content to increase performance, limits network traffic</li>
                                <li>Filters requests based on their destinations</li>
                            </ul> 
                            <li>Widely used in private networks in companies</li>
                            <li>Most of the proxy servers today are Web proxy servers</li>
                        </ul>
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Reverse Proxy Server</li>
                    </hgroup>
                    <div class="h-drawing" id="1RpfjNLhFSzu7mDdWVvV3ZldHEhzx9rLB1KpHpdL9bno" 
                        style="height: 270px"></div>
                    <ul class="xx-small">
                        <li>Reverse Proxy Server</li>
                        <ul>
                            <li>Aggregates multiple request-response interactions with back-end systems</li>
                            <li>Processes the request on behalf of the client</li>
                            <li>Provides additional values to communication</li>
                            <ul>
                                <li>Data transformations</li>
                                <li>Security &ndash; authentication, authorization</li>
                                <li>Orchestration of communication with back-end systems</li>
                            </ul>
                            <li>Examples: Enterprise Service Bus, Security Gateway</li>
                        </ul>
                    </ul>
                </div>

            </section>
        </section>
            
        <div class="slide outline"></div>
        
        <section>
            <header>Simple Protocol Example</header>

            <div class="slide">
                <hgroup>
                    <h1>TCP Socket Protocol</h1>
                </hgroup>
                <ul class="xx-small">
                    <li>Example simple TCP Socket protocol in Java<a rel="code" href="https://github.com/tomvit/mdw/blob/master/examples/protocols/src/com/vitvar/ctu/mdw/SimpleProtocol.java">&nbsp;</a>
                    </li>
                    <ul>
                        <li>functions (verbs): <code>add</code> and <code>bye</code></li>
                        <li>data syntax: <code>add</code> <code>"^[0-9]+ [0-9]+$"</code>, <code>bye</code> <code>"^$"</code> 
							(regular grammars)</li>
                        <li>data semantics: <code>add</code> decimal numbers, <code>bye</code> none</li> 
                        <li>process: transitions <code>S1&#151;add&#151;S1</code>, <code>S1&#151;bye&#151;S0</code>, 
                            where <code>S0</code>, <code>S1</code> are states such that<br/>
                            <code>S1=connection established</code>, <code>S0=connection closed</code>.</li>
                    </ul>
                    <pre class="brush: java; class-name: 'tight'">
                        package com.vitvar.ctu.mdw;

                        import java.io.*;
                        import java.net.*;
                        import java.util.regex.*;

                        /**
                         * Simple protocol example. The class starts a listener on the port 8080.
                         * When a client connects, the server parses the input in a form "add a b", 
                         * where "a" and "b" are integer values, adds the two numbers and sends 
                         * the result back to the client. The communication ends when the client sends "bye".
                         * 
                         * @author tomas@vitvar.com
                         *
                         */
                        public class SimpleProtocol {

                            public static void main(String[] args) throws IOException {
                                // info message to the console
                                System.out.println("Listening on port 8080...");
                        </pre>
                </ul>
            </div>    

            <div class="slide">
                <hgroup>
                    <h1>TCP Socket Protocol (Cont.)</h1>
                </hgroup>
				<ul class="xx-small">
                    <div style="padding-top: 10px">
                    <pre class="brush: java; class-name: 'tight'; first-line: 22">
                            // listen on port 8080
                            ServerSocket serverSocket = new ServerSocket(8080);
                            Socket clientSocket = serverSocket.accept();

                            // create reader and writer to read from and write to the socket
                            PrintWriter out = new PrintWriter(clientSocket.getOutputStream(), true);
                            BufferedReader in = new BufferedReader(
                                new InputStreamReader(clientSocket.getInputStream()));

                            // print information to the client
                            out.println("verbs: add a b, bye");

                            // grammar definition
                            Pattern p = Pattern.compile("^add ([0-9]+) ([0-9]+)$");
                            Matcher m; String message;      

                            // read input from the client and process the input
                            while ((message = in.readLine()) != null) {   
                                if ((m = p.matcher(message)).matches())
                                    out.println("Result: " + (Integer.parseInt(m.group(1)) + 
                                        Integer.parseInt(m.group(2))));
                                else
                                    if (message.equals("bye")) {
                                        out.println("Goodbye!");
                                        break;
                                    } else
                                        out.println("Do not understand: " + message);
                            }
                        }
                    }</pre>
                    </div>
				</ul>	
            </div>    

            <div class="slide">
                <hgroup>
                    <h1>Testing</h1>
                </hgroup>
                <ul class="x-small">
                    <li>Many app protocols communicate in plain text</li>
                    <ul>
                        <li>messages in ASCII or Base64 encoded (printable chars only)</li>
                        <li>this allows to test them just with Telnet</li>
                        <ul>
                            <li>Telnet does not know about any protocol-specific semantics</li>
                            <li>only opens, reads/writes, and closes the socket</li>
                        </ul>
                    </ul>
                    <li>Testing our protocol</li>
                    <pre class="brush: bash; class-name='xx-small'">
						# 1. run the listener
						bin/simple_protocol.sh
						Listening on port 8080...
						
                        # 2. open the socket using telnet but first dig for DNS lookup							
                        telnet 127.0.0.1 8080
                        Trying 127.0.0.1...
                        Connected to localhost.
                        Escape character is '^]'.
                        Verbs: add a b, bye.
                        add 3 4
                        The result is: 7
                        minus 7 5
                        Do not understand: minus 7 5
                        bye
                        Goodbye!
                    </pre>
                </ul>
            </div>    
        </section>
        
        <div class="slide outline">
        </div>
        
        <section>
            <header>Introduction to HTTP</header>

            <div class="slide">
                <hgroup>
                    <h1>Hypertext Transfer Protocol &ndash; HTTP</h1>
                </hgroup>
                <ul class="small">
                    <li>Application protocol, basis of Web architecture</li>
                    <ul>
                        <li>Part of HTTP, URI, and HTML family</li>
                        <li>Request-response protocol</li>
                    </ul>
                    <li>One socket for single request-response</li>
                    <ul>
                        <li>original specification</li>
                        <li>have changed due to performance issues</li>
                        <ul>
                            <li>many concurrent requests</li>
                            <li>overhead when establishing same connections</li>
                            <li>HTTP 1.1 offers persistent connection and pipelining</li>
                        </ul>
                    </ul>
                    <li>HTTP is stateless</li>
                    <ul>
                        <li>Multiple HTTP requests cannot be normally related at the server</li>
                        <ul>
                            <li>"problems" with state management</li>
                            <li>REST goes back to the original HTTP idea</li>
                        </ul>
                    </ul>
                </ul>
            </div>

            <div class="slide">
                <hgroup>
                    <h1>HTTP Request and Response</h1>
                </hgroup>
                <ul class="small">
                    <li>Request Syntax</li>
                    <pre class="brush: plain; gutter: false">
                        method uri http-version &lt;crlf>
                        (header : value &lt;crlf>)* 
                        &lt;crlf>                    
                        [ data ]
                    </pre>
                    <li>Response Syntax</li>
                    <pre class="brush: plain; gutter: false">
                        http-version response-code [ message ]  &lt;crlf>
                        (header : value &lt;crlf>)* 
                        &lt;crlf>
                        [ data ]
                    </pre>
                    <li>Semantics of terms</li>
                    <pre class="brush: plain; gutter: false">
                        method         = "GET" | "POST" | "DELETE" | "PUT" | "HEAD" | "OPTIONS" 
                        uri            = [ path ] [ ";" params ] [ "?" query ] 
                        http-version   = "HTTP/1.0" | "HTTP/1.1"
                        response-code  = valid response code 
                        header : value = valid HTTP header and its value
                        data           = resource state representation (hypertext)
                    </pre>
                </ul>
            </div>
            
        	<div class="slide" id="http-request">
				<hgroup>
					<h1>Serving HTTP Request</h1>
				</hgroup>	
				<div class="h-drawing" style="height: 180px" 
				  id="1c1oNNZgurIxOEDHbnZuPHKR9I-H1VhoeOpTWa6-vslI"></div>
                <ul class="xx-small">
                    <li>IP and TCP addressing</li>
                    <ol>
                        <li>User enters URL <code>http://company.cz:8080/orders</code> to the browser</li>
                        <li>Browser gets an IP address for <code>company.cz</code>, <code>IP:138.232.189.127</code></li>
                        <li>Browser and Web Server creates a socket <code>[147.32.100.5:3223;138.232.189.127:8080]</code></li>
                    </ol>
                    <li>Application addressing</li>
                    <ol start="4">
                        <li>Browser sends HTTP request, that is, writes following data to the socket</li>
                        <pre class="brush: plain; class-name: 'tight'">
                        GET /orders HTTP/1.1
                        Host: company.cz
                        </pre>
                        <li>Web server passes the request to the web application <code>company.cz</code> which serves 
							<code>GET orders</code> and that writes a response back to the socket.</li>                    
                    </ol>
                </ul>
			</div>

            <div class="slide">
				<hgroup>
					<h1>HTTP Listener</h1>
				</hgroup>
                <ul class="x-small">
                    <li>HTTP listener implementation in Java using Jetty<a rel="code" 
             href="https://github.com/tomvit/mdw/blob/master/examples/protocols/src/com/vitvar/ctu/mdw/HttpListener.java">&nbsp;</a></li>
                    <ul>
						<li>Server listens on port <code>8080</code></li>
						<li>Jetty parses HTTP request data into <code>HttpServletRequest</code> object. 
						<li>When a client connects, the method <code>handleRequest</code> is called</li>
						<li>The method tests the value of the <code>host</code> header and responds back if the header
							matches <code>company.cz</code> value.</li>					
                    </ul>
                    <pre class="brush: java; class-name: 'tight'; first-line: 1">
                    /** handles the request when client connects **/
                    public void handleRequest(HttpServletRequest request, 
                            HttpServletResponse response) throws IOException, ServletException {

                        // test if the host is company.cz
                        if (request.getHeader("Host").equals("company.cz")) {
                            response.setStatus(200);
                            response.setHeader("Content-Type", "text/plain");
                            response.getWriter().write("This is the response");
                            response.flushBuffer();
                        } else
                            response.sendError(400); // bad request
                    }
                    </pre>
                </ul>
			</div>

            <div class="slide" id="ncat">
				<hgroup>
					<h1>HTTP Listener (Cont.)</h1>
				</hgroup>
                <ul class="xx-small">
                    <li>Test it using Telnet</li>
                    <pre class="brush: bash; class-name: 'tight'">
                        telnet 127.0.0.1 8080
                        # ...lines omitted due to brevity
                        GET /orders HTTP/1.1
                        Host: company.cz
                        
                        HTTP/1.1 201 OK
                        Content-Type: plain/text
                        
                        This is the response...
                    </pre>  
					<li>HTTP listener in bash</li>
					<ul>
						<li>Use it to test incomming HTTP connections quickly</li>
						<li>Uses <code>nc</code> utility (netcat)</li>
					</ul>
					<pre class="brush: bash; class-name: 'tight'">
						# ctrl-c to stop http listener
						control_c() {
						  echo -en "\n* Exiting\n"
						  exit $?
						}
						trap control_c SIGINT

						for (( ; ; ))
						do
						        echo -e "\n\n* Listening on port $1..."
						        echo -e "\nHTTP/1.0 204 No Content\n\n" | nc -l $port
						done</pre>
                </ul>
			</div>

            <div class="slide">
				<hgroup>
					<h1>Virtual Web Server</h1>
				</hgroup>
                <ul class="x-small">
					<li>Virtual server</li>
					<ul>
						<li>Configuration of a named virtual web server</li>
						<li>Web server uses host request header to distinguish among multiple virtual 
							web servers on a single physical host.</li>
					</ul>
                    <li>Apache virtual Web server configuration</li>
					<ul class="x-small">
						<li>Two virtual servers hosted on a single physical host</li>
						<pre class="brush:plain; class-name: 'tight'">
							# all IP addresses will be used for named virtual hosts
							NameVirtualHost *:80
							
							&lt;VirtualHost *:80>
							        ServerName company.com
							        ServerAdmin admin@company.com
							        DocumentRoot /var/www/apache/company.com
							&lt;/VirtualHost>
							
							&lt;VirtualHost *:80>
							        ServerName firm.cz
							        ServerAdmin admin@firm.cz
							        DocumentRoot /var/www/apache/firm.cz
							&lt;/VirtualHost></pre>
					</ul>
                </ul>
			</div>
            
            <div class="slide" id="curl">
    			<hgroup>
					<h1>Better Support for HTTP Testing</h1>
				</hgroup>
                <ul class="x-small">
                    <li>Use <code>curl</code> to test HTTP protocol</li>
                    <pre class="brush: plain; class-name: 'tight'">
                        Usage: curl [options...] &lt;url>
                        
                        -X/--request &ltcommand>          Specify request command to use
                        -H/--header &lt;line>              Custom header to pass to server
                        -d/--data &lt;data>                HTTP POST data
                        -b/--cookie &lt;name=string/file>  Cookie string or file to read cookies from
                        -v/--verbose                    Make the operation more talkative                            
                    </pre>                        
                    <li>Example</li>
                    <pre class="brush: plain; class-name: 'tight'">
                        curl -v -H "Host: company.cz"  127.0.0.1:8080
                        
                        * About to connect() to 127.0.0.1 port 8080 
                        *   Trying 127.0.0.1... connected
                        * Connected to 127.0.0.1 port 8080 
                        &gt; GET / HTTP/1.1
                        &gt; User-Agent: curl/7.20.0 (i386-apple-darwin10.3.2) libcurl/7.20.0 OpenSSL/0.9.8n
                        &gt; Accept: */*
                        &gt; Host: company.cz
                        &gt; 
                        &lt; HTTP/1.1 201 OK
                        &lt; Connection: keep-alive
                        &lt; Content-Type: plain/text
                        &lt; 
                        &lt; This is the response...                            
                    </pre>                        
                </ul>
			</div>
                
            <div class="slide outline"></div>            
            
            <section>
                <header>State Management</header>
                
                <div class="slide" id="state-management">
                    <hgroup>
                        <h1>State Management</h1>
                    </hgroup>
                    <ul class="small">
                        <li>HTTP is a stateless protocol &#150; original design</li>
                        <ul>
                            <li>No information to relate multiple interactions at server-side</li>
                            <ul>
                                <li>Except <code>Authorization</code> header is copied in every request</li> 
                                <li>IP addresses do not work, one public IP can be shared by multiple clients</li>
                            </ul>
                        </ul>
                        <li>Solutions to check for a valid state at server-side</li>
                        <ul>
                            <li><b>Cookies</b> &ndash; obvious and the most common workaround</li>
                            <ul>
                                <li><span class="h-ref" id="rfc-2109">RFC 2109 &ndash; HTTP State Management Mechanism</span></li>
                                <li>Allow clients and servers to talk in a context called <b>sessions</b></li>
                            </ul>
                            <li><b>Hypertext</b> &ndash; original HTTP design principle</li>
                            <ul>
                                <li>App states represented by resources (hypermedia), links define transitions between states</li>
                                <li>Adopted by the REST principle <b>statelessness</b></li>                        
                            </ul>
                        </ul>
                    </ul>
                </div>
                
                <div class="slide">
        			<hgroup>
    					<h1>Interaction with Cookies</h1>
    				</hgroup>
                    <ul class="small">
                        <li>Request-response interaction with cookies</li>
                        <ul>
                            <li>Session is a logical channel maintained by the server</li>
                        </ul>
                        <div class="h-drawing" style="height: 250px" id="1mVCe8EtqVApZVRV_RHYQKtqDNELKdo84qzCqGvAs7iA"></div>
                        <li>Stateful Server</li>
                        <ul>
                            <li>Server remembers the session information in a server memory</li>
                            <li>Server memory is a non-persistent storage, when server restarts the memory content is lost!</li>
                        </ul>
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Set-Cookie and Cookie Headers</h1>
                    </hgroup>
                    <ul class="xx-small">
                        <li><code>Set-Cookie</code> response header</li>
                        <pre class="brush: plain; ">
                            set-cookie = "Set-Cookie:" cookie ("," cookie)*
                              cookie    = NAME "=" VALUE (";" cookie-av)*
                              cookie-av = "Comment" "=" value
                                        | "Domain" "=" value
                                        | "Max-Age" "=" value
                                        | "Path" "=" value
                        </pre>
                        <ul>
                            <li><code>domain</code> &ndash; a domain for which the cookie is applied</li>
                            <li><code>Max-Age</code> &ndash; number of seconds the cookie is valid</li>
                            <li><code>Path</code> &ndash; URL path for which the cookie is applied</li>
                        </ul>
                        <li><code>Cookie</code> request header. A client sends the cookie in a request if:</li>
                        <ul>
                            <li><code>domain</code> matches the origin server's fully-qualified host name</li>
                            <li><code>path</code> matches a prefix of the request-URI</li>
                            <li><code>Max-Age</code> has not expired</li>
                        </ul>
                        <pre class="brush: plain;">
                            cookie  = "Cookie:" cookie-value (";" cookie-value)*
                              cookie-value    = NAME "=" VALUE [";" path] [";" domain]
                              path            = "$Path" "=" value
                              domain          = "$Domain" "=" value                        
                        </pre>
                        <ul>
                            <li><code>domain</code>, and <code>path</code> are values from corresponding attributes of 
                            the <code>Set-Cookie</code> header</li>
                        </ul>
                        
                    </ul>                    
                </div>
                
                <div class="slide" id="session-object">
        			<hgroup>
    					<h1>Session Management Java Class</h1>
    				</hgroup>
                    <ul class="xx-small">
                        <li>Manages client sessions in a server memory<a rel="code" href="https://github.com/tomvit/mdw/blob/master/examples/protocols/src/com/vitvar/ctu/mdw/Sessions.java">&nbsp;</a></li> 
                    <pre class="brush: java; class-name: 'tight'; first-line: 1">
                        public class Sessions&lt;E> {

                            // storage for the session data;
                            private Hashtable&lt;String, E> sessions = new Hashtable&lt;String, E>();

                            /** Returns session id based on the information in the http request **/
                            public String getSessionID(HttpServletRequest request) throws Exception {
                                String sid = null;

                                // extract the session id from the cookie
                                if (request.getHeader("cookie") != null) {
                                    Pattern p = Pattern.compile(".*session-id=([a-zA-Z0-9]+).*");
                                    Matcher m = p.matcher(request.getHeader("cookie"));
                                    if (m.matches()) sid = m.group(1);
                                }

                                // create the session id md5 hash; use random number to generate a client-id
                                // note that this is a simple solution but not very reliable 
                                if (sid == null || sessions.get(sid) == null) {
                                    MessageDigest md = MessageDigest.getInstance("MD5");
                                    md.update(new String(request.getRemoteAddr() + 
                                        Math.floor(Math.random()*1000)).getBytes());
                                    sid = Utils.toHexString(md.digest());
                                }
                                return sid;
                            }

                            public E getData(String sid) ... // returns session data from sessions object
                            public void setData(String sid, E d) ... // sets session data to sessions object
                        }                        
                    </pre>
                    </ul>
    			</div>

                <div class="slide">
            		<hgroup>
    					<h1>Stateful Server Implementation</h1>
    				</hgroup>
                    <ul class="x-small">
                        <li>Simple per-client counter<a rel="code" 
                 href="https://github.com/tomvit/mdw/blob/master/examples/protocols/src/com/vitvar/ctu/mdw/Counter.java">&nbsp;</a></li>

                        <pre class="brush: java; class-name: 'tight'; first-line: 1">
                        public void handleRequest(HttpServletRequest request,
                                HttpServletResponse response) throws Exception {
                            // get the session id
                            String sid = sessions.getSessionID(request);

                            // create the new data if none exists
                            if (sessions.getData(sid) != null)
                                sessions.setData(sid, 
                                    Integer.valueOf(sessions.getData(sid).intValue() + 1));
                            else
                                sessions.setData(sid, Integer.valueOf(1));

                            // send the response
                            response.setStatus(200);
                            response.setHeader("Set-Cookie", "session-id="+ sid + "; MaxAge=3600");
                            response.setHeader("Content-Type", "text/plain");
                            response.getWriter().write("Number of hits from you: " + 
                                sessions.getData(sid).toString());
                            response.flushBuffer();
                        }
                        </pre>
                        <li class="task">Task</li>
                        <ul>
                            <li>What happens when the server restarts?</li>                    
                            <li>How do you change the code to count requests from all clients?</li>
                        </ul>
                    </ul>
    			</div>

                <div class="slide">
                	<hgroup>
    					<h1>Testing</h1>
    				</hgroup>
                    <ul class="x-small">
                        <li>Testing</li>
                        <ul>
                            <li><code>curl</code> will require you to specify cookies in every request</li>
                            <li>Browser handles cookies automatically</li>
                        </ul>
                        <pre class="brush: bash">
                            # run curl for the first time
                            curl -v 127.0.0.1:8080
                            > GET / HTTP/1.1
                            > Host: 127.0.0.1:8080
                            > Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401
                            > 
                            &lt; HTTP/1.1 200 OK
                            &lt; Set-Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401;max-age=3600
                            &lt; 
                            Number of hits from you: 1

                            # copy the cookie session-id from previous response
                            curl -v -b session-id=3a9c3cdc5ff36434aa1ba860727ca401 127.0.0.1:8080
                            > GET / HTTP/1.1
                            > Host: 127.0.0.1:9900
                            > Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401
                            > 
                            &lt; HTTP/1.1 200 OK
                            &lt; Set-Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401;max-age=3600
                            &lt; 
                            Number of hits from you: 2
                        </pre>
                    </ul>
    			</div>

            </section>

            <div class="slide outline"></div>

            <section>
                <header>Persistent Communication and Pipelining</header>
                
        		<div class="slide">
    				<hgroup>
    					<h1>Non-Persistent, Persistent, Pipelining</h1>
    				</hgroup>
    				<div class="h-drawing" style="height: 250px; margin-bottom: 30px" 
    					id="1YgCc7gq-k3j4oWy8am9wiEg4ge0UPUk4moO6NV5W-gU"></div>
    				<ul class="x-small">
                        <li>HTTP 1.1 improvements over version 1.0</li>
                        <ul>
        					<li>non-persistent &#150; one socket for one request&ndash;response (v1.0)</li>
        					<li><b>persistent</b> &ndash; one socket for multiple interactions</li>
                            <ul>
        					    <li>reduces latency (no repeating handshaking)</li>
                            </ul>
        					<li><b>pipelining</b> &ndash; multiple requests, no wait for responses</li>
                            <ul>
        					    <li>the server must preserve the order of messages when sending responses.</li>
                            </ul>
    				    </ul>
                    </ul>
    			</div>                                    
                
            </section>

        </section>

    </body>
</html>
        
        
