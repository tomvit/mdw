<!DOCTYPE html>
<!--
    Middleware and Web Services, CTU course slides
    (cc) 2010-2011 Tomas Vitvar, http://vitvar.com
    written for Humla, an open source HTML5 presentation environment
-->
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="course" content="Middleware and Web Services" />
  <meta name="lecture" content="Lecture 6" />
  <meta name="keywords" content="High Availability, Load Balancer, Replication" />

  <link type="text/css" rel="stylesheet" href="css/meta.css">
  </link>
  <link type="text/css" rel="stylesheet" href="css/ctu-fit.css">
  </link>
  <link type="text/css" rel="stylesheet" href="humla/lib/core/humla.css">
  </link>

  <script type="text/javascript" src="humla/lib/humla.js"></script>
  <title>High Availability and Performance</title>
</head>

<body>
  <footer>
    <p><b>#META_LECTURE#: #TITLE#</b>,&nbsp;<span class="meta_semester" />,&nbsp;
      <span class="meta_twitter" /></p>
    <p><b>&#8210; #SLIDE_NO# &#8210;</b></p>
  </footer>

  <div class="slide intro">
    <hgroup>
      <h1><span class="meta_course" /></h1>
      <h2>#META_LECTURE#: #TITLE#</h2>
    </hgroup>
    <div class="author">
      <p class="meta_author" />
      <p><span class="meta_email" /> &bull; <span class="meta_twitter" /> &bull;
        <span class="meta_web" /></p>
    </div>
    <center>
      <div class="meta_logo"></div>
    </center>
    <div class="org">
      <p class="meta_org" />
      <p><span class="meta_orgfac" /> &bull; <span class="meta_field" />
        &bull; <span class="meta_orgweb" /></p>
    </div>
    <div class="etc">
      <div class="text-info">
        Modified: #LAST_MODIFIED#<br />
        Humla v#HUMLA_VERSION#
      </div>
      <a href="http://creativecommons.org/licenses/by-sa/3.0/">
        <div class="license"></div>
      </a>
      <div class="oppa"></div>
    </div>
  </div>

  <div class="slide">
    <hgroup>
      <h1>Good Performance</h1>
    </hgroup>
    <ul class="small">
      <li>What influences good performance?</li>
      <ul>
        <li>Number of users and concurrent connections</li>
        <li>Number of messages and messages' sizes</li>
        <li>Number of services</li>
        <li>Infrastructure &ndash; capacity, availability, configuration, ...</li>
      </ul>
      <li>How can we achieve good performance?</li>
      <ul>
        <li>Infrastructure</li>
        <ul>
          <li>Scalability, failover, cluster architectures</li>
        </ul>
        <li>Performance tuning</li>
        <ul>
          <li>Application Server, JVM memory, OS-level tuning, Work managers configuration</li>
        </ul>
        <li>Service configuration</li>
        <ul>
          <li>Parallel processing, process optimization</li>
        </ul>
      </ul>
    </ul>
  </div>

  <div class="slide outline"></div>

  <section>
    <header>Definitions</header>

    <div class="slide">
      <hgroup>
        <h1>Definitions</h1>
      </hgroup>
      <ul class="xx-small">
        <li>Scalability</li>
        <ul>
          <li>server scalability</li>
          <ul>
            <li>ability of a system to scale &ndash; when input load changes</li>
            <li>users should not feel a difference when more users
              access the same application at the same time</li>
            <li><b>horizontal scaling</b></li>
            <ul>
              <li>adding new instances of applications/servers</li>
            </ul>
            <li><b>vertical scaling</b></li>
            <ul>
              <li>adding new resources (CPU, memory) to a server instance</li>
            </ul>
          </ul>
          <li>network traffic</li>
          <ul>
            <li>bandwidth capacity influences performance too</li>
            <li>service should limit the network traffic through caching</li>
          </ul>
        </ul>
        <li>Availability</li>
        <ul>
          <li>probability that a service is operational at a particular time</li>
          <ul>
            <li>e.g., 99.9987% availability &ndash; downtime ~44 seconds/year</li>
          </ul>
        </ul>
        <li>SLA &ndash; Service Level Agreement</li>
        <ul>
          <li>Guarantee of service availability</li>
          <li>When availability is below a guaranteed value, a customer can get a discount</li>
        </ul>
      </ul>
    </div>

    <div class="slide">
      <hgroup>
        <h1>Definitions (Cont.)</h1>
      </hgroup>
      <ul class="x-small">
        <li>High Availability</li>
        <ul>
          <li>When a server instance fails, operation of the application can continue</li>
          <li>Failures should affect application availability and performance as little as possible</li>
        </ul>
        <li>Application Failover</li>
        <ul>
          <li>When an application component performing a job becomes unavailable,
            a copy of the failed object finishes the job.</li>
          <li>Issues</li>
          <ul>
            <li>A copy of the failed object must be available</li>
            <li>A location and operational status of available objects must be available</li>
            <li>A processing state must be replicated</li>
          </ul>
        </ul>
        <li>Load Balancing</li>
        <ul>
          <li>Distribution of incoming requests across server instances</li>
        </ul>
      </ul>
    </div>

    <div class="slide">
      <hgroup>
        <h1>Performance Metrics</h1>
      </hgroup>
      <ul class="x-small">
        <li>Response Time</li>
        <ul>
          <li>A client-side metric</li>
        </ul>
        <div class="h-drawing" style="height: 300px" id="1rgjQBi7cWEbNSjNYmnhaFTqcoXNi6JbLaGmNajArRUY"></div>
      </ul>
      <ul class="xx-small">
        <ul>
          <li>CPU intensive service or a bad configuration of a service</li>
          <ul>
            <li>consider asynchronous processing when CPU intensive</li>
          </ul>
          <li>Writing to a data store</li>
        </ul>
      </ul>
    </div>

    <div class="slide">
      <hgroup>
        <h1>Performance Metrics</h1>
      </hgroup>
      <ul class="x-small">
        <li>Queries/Requests per Second (QPS)</li>
        <ul>
          <li>A server-side metric</li>
        </ul>
        <div class="h-drawing" style="height: 300px" id="1BhopVXexuS5coYLBbcrBi1SiUY3YNcr-K4usFXU6IwM"></div>
      </ul>
      <ul class="xx-small">
        <ul>
          <li>Caching may improve performance</li>
          <ul>
            <li>even if data changes often, with high QPS caching improves a lot</li>
          </ul>
        </ul>
      </ul>
    </div>
  </section>

    <div class="slide outline"></div>

    <section>

      <header>Load Balancers</header>

      <div class="slide">
        <hgroup>
          <h1>Load Balancing</h1>
        </hgroup>
        <ul class="small">
          <li>Distributes a load to multiple app/object instances</li>
          <ul>
            <li>App instances run on different machines</li>
            <li>Load sharing: equal or with preferences</li>
            <li>Health checks</li>
          </ul>
          <li>Types</li>
          <ul class="x-small">
            <li>DNS-based load balancer</li>
            <ul>
              <li>DNS Round Robin</li>
            </ul>
            <li>NAT-based load balancer (Layer-4)</li>
            <li><b>Reverse-proxy load balancer</b> (Layer-7)</li>
            <ul>
              <li>application layer</li>
              <li>Sticky sessions</li>
              <ul>
                <li>JSession, JSession-aware load balancer</li>
              </ul>
            </ul>
            <li>Client-side load balancer</li>
            <ul>
              <li>LB run by a client
              <li>a client uses a replica-aware stub of the object
                from the server</li>
            </ul>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>DNS-based Load Balancer</h1>
        </hgroup>
        <ul class="x-small">
          <li>DNS Round Robin</li>
          <ul>
            <li>A DNS record has multiple assigned IP addresses</li>
            <li>DNS system delivers different IP addresses from the list</li>
            <li>Example DNS A Record:<br />
              <code>company.com A 147.32.100.71 147.32.100.72 147.32.100.73</code></li>
          </ul>
          <li>Advantages</li>
          <ul>
            <li>Very simple, easy to implement</li>
          </ul>
          <li>Disadvantages</li>
          <ul>
            <li>IP address in cache, could take hours to re-assign</li>
            <li>No information about servers' loads and health</li>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>Reverse Proxy Load Balancer</h1>
        </hgroup>
        <div class="h-drawing" style="margin-top: 40px; height: 450px" id="1QtCAcD0R571rYmeP1hrofveZ3x6F7P61rfUpEswxOl0"></div>
      </div>

      <div class="slide">
        <hgroup>
          <h1>HTTP Sticky Sessions Example</h1>
        </hgroup>
        <div class="h-drawing" id="1hzFB_41gJmkKQHpcSODvengGnHW98UYv1x1xZHt4XMA" style="height: 320px; margin: 20px"></div>
        <ul class="x-small">
          <li>How to identify a server that hosts the session state</li>
          <ul>
            <li>Passive cookie persistence &ndash; LB uses a cookie from the server</li>
            <li>Active cookie persistence &ndash; LB adds its own cookie</li>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>Types of Load Balancers</h1>
        </hgroup>
        <ul class="x-small">
          <li>Software</li>
          <ul>
            <li>Apache <code>mod_proxy_balancer</code></li>
            <ul>
              <li>HTTP Session persistence &ndash; sticky sessions</li>
            </ul>
            <li>WebLogic proxy plug-in</li>
            <pre class="brush: xml">
								&lt;Location /soa-infra>
    								SetHandler weblogic-handler
    								WebLogicCluster czfmwapp03-vf:8001,czfmwapp04-vf:8001,czfmwapp05-vf:8001
								&lt;/Location> 
							</pre>
            <ul class="no-bullet">
              <li><code>/soa-infra</code> is a first part of an URL path that rules in this <code>Location</code> will be applied (this is a standard Apache configuration mechanism)</li>
              <li><code>czfmwapp{N}</code> is a hostname that corresponds to a virtual IP to which the managed server JVM processes is bounded (using the tcp port <code>8001</code>).
              <li><code>WebLogicCluster</code> specifies the list of servers for load balancing</li>
            </ul>
          </ul>
          <li>Hardware</li>
          <ul>
            <li>Cisco, Avaya, Barracude</li>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>Round-Robin Algorithm</h1>
        </hgroup>
        <ul class="xx-small">
          <li>Uses</li>
          <ul class="no-bullet">
            <li><code>request</code> &ndash; client request with or without a cookie information</li>
            <li><code>server_list</code> &ndash; a list of servers that can process the request</li>
            <li><code>rbinx</code> &ndash; round robin index</li>
            <li><code>sticky_sessions</code> &ndash; associative array of pairs <code>&lt;session_id,server&gt;</code></li>
            <li><code>unhealthy_treshhold</code> &ndash; a number of negative consecutive health checks
              before moving the server to the "unhealthy" state.</li>
          </ul>
          <li>Round Robin Algorithm</li>
          <ul>
            <li>if <code>session_id</code> exist in the <code>request</code> and in <code>sticky_sessions</code></li>
            <ul>
              <li>send the <code>request</code> to the server <code>sticky_sessions[session_id]</code></li>
            </ul>
            <li>otherwise</li>
            <ul>
              <li>send the <code>request</code> to the <code>rbinx</code> server in the <code>server_list</code></li>
              <li>extract <code>session_id</code> from the response from the server</li>
              <li>if the <code>session_id</code> exist, add a pair <code>&lt;session_id;server_list[rbinx]&gt;</code> to <code>sticky_sessions</code></li>
              <li>increase <code>rbinx</code> by one or reset it to <code>0</code> if it exceeds the length of <code>server_list</code></li>
            </ul>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>Health Check</h1>
        </hgroup>
        <ul class="xx-small">
          <li>Health Check</li>
          <ul>
            <li>For each server in the <code>server_list</code></li>
            <ul>
              <li>call the server's heatlhcheck endpoint</li>
              <li>if a number of failed health checks for the server exceeds the <code>unhealthy_threshold</code></li>
              <ul>
                <li>remove the server from the <code>server_list</code></li>
              </ul>
              <li>if the server was unhealthy and a there was a successful healthcheck</li>
              <ul>
                <li>add the server back to the <code>server_list</code></li>
              </ul>
            </ul>
          </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>Session State Persistence and Replication</h1>
        </hgroup>
        <ul class="xx-small">
          <div class="h-drawing" style="height: 290px" id="1PiI-1CeVkQTYUgOPHyk3wqJufQl9cYQz5vlNziERE74"></div>
          <li>Session persistence</li>
          <ul>
            <li>Session information is maintained in the database</li>
            <li>Does not require sticky sessions</li>
            <li>Implements <code>HttpSession</code> interface that writes data to the DB</li>
          </ul>
          <li>In-memory replication</li>
          <ul>
            <li>A <b>primary server</b> holds a session state, the <b>secondary server</b>
              holds its replica.</li>
            <li>Information about primary and secondary servers are part of JSession</li>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>In-Memory Replication</h1>
        </hgroup>
        <ul class="x-small">
          <li>Session format</li>
          <ul>
            <li>It's a cookie</li>
            <li><code>JSESSIONID=SESSION_ID!PRIM_SERVER_ID!SEC_SERVER_ID!CREATION_TIME</code></li>
            <ul class="no-bullet">
              <li><code>SESSION_ID</code> &ndash; session id, generated by the server to identify memory associated with
                the session on the server</li>
              <li><code>PRIM_SERVER_ID</code> &ndash; ID of the managed server holding the session data</li>
              <li><code>SEC_SERVER_ID</code> &ndash; ID of the managed server holding the session replica</li>
              <li><code>CREATION_TIME</code> &ndash; time the session data was created/updated</li>
            </ul>
          </ul>
          <li>How LB uses this information</li>
          <ul>
            <li>LB has information whether the server is running or not (via healthchecks)</li>
            <li>if the primary server is running, it redirects the request there</li>
            <li>if the primary server is not running, it redirects the request to the secondary server directly</li>
            <li>if primary and secondary servers are not running, it redirect the request to any other server it has in the list &ndash; this may cause side effects!</li>
          </ul>
        </ul>
      </div>

      <div class="slide">
        <hgroup>
          <h1>In-Memory Replication Scenarios</h1>
        </hgroup>
        <center>
          <div class="h-drawing" id="1APKL5IK-WG_8rlF6g__Q5TwxVrwmW9a4KPbK10JiKGU" style="width: 690px"></div>
        </center>
      </div>

    </section>



</body>